<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ========== VUES LIGNES LOT ========== -->
    
    <!-- Vue Tree Lignes Lot -->
    <record id="view_inventory_lot_line_tree" model="ir.ui.view">
        <field name="name">stockex.inventory.lot.line.tree</field>
        <field name="model">stockex.inventory.lot.line</field>
        <field name="arch" type="xml">
            <list string="Inventaire par Lot" editable="bottom" 
                  decoration-danger="lot_state == 'expired'"
                  decoration-warning="lot_state == 'warning'"
                  decoration-info="lot_state == 'quarantine'">
                <field name="product_id" readonly="1"/>
                <field name="lot_id" options="{'no_create': True}"/>
                <field name="lot_name"/>
                <field name="expiration_date"/>
                <field name="days_to_expiry" optional="show"/>
                <field name="lot_state" widget="badge" 
                       decoration-success="lot_state == 'good'"
                       decoration-warning="lot_state == 'warning'"
                       decoration-danger="lot_state == 'expired'"
                       decoration-info="lot_state == 'quarantine'"/>
                <field name="theoretical_qty" sum="Total Théorique"/>
                <field name="real_qty" sum="Total Réel"/>
                <field name="difference" sum="Total Écart"/>
                <field name="difference_percent" optional="hide"/>
                <field name="standard_price" optional="hide"/>
                <field name="difference_value" sum="Valeur Totale Écart" optional="show"/>
                <field name="note" optional="hide"/>
            </list>
        </field>
    </record>
    
    <!-- Vue Form Ligne Lot -->
    <record id="view_inventory_lot_line_form" model="ir.ui.view">
        <field name="name">stockex.inventory.lot.line.form</field>
        <field name="model">stockex.inventory.lot.line</field>
        <field name="arch" type="xml">
            <form string="Détail Lot">
                <header>
                    <field name="lot_state" widget="statusbar"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <!-- Statistiques lot -->
                    </div>
                    
                    <group>
                        <group name="product_info">
                            <field name="product_id" readonly="1"/>
                            <field name="lot_id" options="{'no_create': True}"/>
                            <field name="lot_name"/>
                        </group>
                        <group name="dates">
                            <field name="expiration_date"/>
                            <field name="removal_date" optional="hide"/>
                            <field name="use_date" optional="hide"/>
                            <field name="days_to_expiry" 
                                   decoration-danger="days_to_expiry &lt; 0"
                                   decoration-warning="days_to_expiry &lt; 30 and days_to_expiry &gt;= 0"/>
                        </group>
                    </group>
                    
                    <group>
                        <group name="quantities">
                            <field name="theoretical_qty"/>
                            <field name="real_qty"/>
                            <field name="difference"/>
                            <field name="difference_percent" widget="percentage"/>
                        </group>
                        <group name="valuation">
                            <field name="standard_price"/>
                            <field name="difference_value" 
                                   decoration-danger="difference_value &lt; -1000"
                                   decoration-success="difference_value &gt; 1000"/>
                        </group>
                    </group>
                    
                    <group>
                        <field name="note" placeholder="Remarques sur ce lot..."/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>
    
    <!-- Action Lignes Lot -->
    <record id="action_inventory_lot_lines" model="ir.actions.act_window">
        <field name="name">Inventaires par Lot</field>
        <field name="res_model">stockex.inventory.lot.line</field>
        <field name="view_mode">list,form</field>
        <field name="context">{}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Aucune ligne d'inventaire par lot
            </p>
            <p>
                Les lignes d'inventaire par lot permettent une traçabilité complète
                des quantités par numéro de lot ou série.
            </p>
        </field>
    </record>
    
    <!-- ========== EXTENSION VUES LIGNE INVENTAIRE ========== -->
    
    <!-- DÉSACTIVÉ TEMPORAIREMENT - Vue form pour stockex.stock.inventory.line n'existe pas encore
    <record id="view_stock_inventory_line_form_lot_tracking" model="ir.ui.view">
        <field name="name">stockex.stock.inventory.line.form.lot.tracking</field>
        <field name="model">stockex.stock.inventory.line</field>
        <field name="inherit_id" ref="stockex.view_stock_inventory_line_form"/>
        <field name="arch" type="xml">
            <xpath expr="//header" position="inside">
                <button name="action_open_lot_details" 
                        string="Détail par Lot" 
                        type="object" 
                        class="oe_highlight"
                        invisible="not has_lot_tracking"/>
                <button name="action_generate_lot_lines" 
                        string="Générer Lots" 
                        type="object"
                        invisible="not has_lot_tracking"
                        help="Génère automatiquement les lignes de lot depuis le stock"/>
            </xpath>
            
            <xpath expr="//field[@name='product_id']" position="after">
                <field name="tracking" invisible="1"/>
                <field name="has_lot_tracking" invisible="1"/>
            </xpath>
            
            <xpath expr="//group[@name='quantities']" position="after">
                <notebook invisible="not has_lot_tracking">
                    <page string="Détail par Lot" name="lot_details">
                        <field name="lot_line_ids" context="{'default_product_id': product_id}">
                            <list editable="bottom" 
                                  decoration-danger="lot_state == 'expired'"
                                  decoration-warning="lot_state == 'warning'">
                                <field name="lot_id" options="{'no_create': True}"/>
                                <field name="expiration_date"/>
                                <field name="days_to_expiry"/>
                                <field name="lot_state" widget="badge"/>
                                <field name="theoretical_qty"/>
                                <field name="real_qty"/>
                                <field name="difference"/>
                                <field name="difference_value" optional="hide"/>
                                <field name="product_id" column_invisible="1"/>
                            </list>
                        </field>
                        <group>
                            <group>
                                <label for="real_qty_from_lots"/>
                                <div>
                                    <field name="real_qty_from_lots" class="oe_inline"/>
                                    <span class="text-muted"> (calculé depuis les lots)</span>
                                </div>
                            </group>
                        </group>
                    </page>
                </notebook>
            </xpath>
        </field>
    </record>
    -->
    
    <!-- DÉSACTIVÉ TEMPORAIREMENT - Vue tree pour stockex.stock.inventory.line n'existe pas avec ce nom
    <record id="view_stock_inventory_line_tree_lot_tracking" model="ir.ui.view">
        <field name="name">stockex.stock.inventory.line.tree.lot.tracking</field>
        <field name="model">stockex.stock.inventory.line</field>
        <field name="inherit_id" ref="stockex.view_stock_inventory_line_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='product_id']" position="after">
                <field name="tracking" optional="hide"/>
            </xpath>
        </field>
    </record>
    -->
    
    <!-- ========== EXTENSION VUES LOT (stock.lot) ========== -->
    
    <!-- Extension Form Lot -->
    <record id="view_stock_lot_form_compliance" model="ir.ui.view">
        <field name="name">stock.lot.form.compliance</field>
        <field name="model">stock.lot</field>
        <field name="inherit_id" ref="stock.view_production_lot_form"/>
        <field name="arch" type="xml">
            <!-- Ajout bouton historique inventaires -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button name="action_view_inventory_history" 
                        type="object" 
                        class="oe_stat_button" 
                        icon="fa-history">
                    <div class="o_stat_info">
                        <span class="o_stat_text">Historique</span>
                        <span class="o_stat_text">Inventaires</span>
                    </div>
                </button>
            </xpath>
            
            <!-- Ajout onglet traçabilité -->
            <xpath expr="//notebook" position="inside">
                <page string="Traçabilité &amp; Conformité" name="traceability">
                    <group>
                        <group name="supplier_traceability">
                            <label for="supplier_lot_number"/>
                            <div>
                                <field name="supplier_lot_number" class="oe_inline"/>
                            </div>
                            <label for="internal_lot_number"/>
                            <div>
                                <field name="internal_lot_number" class="oe_inline"/>
                            </div>
                        </group>
                        <group name="dates_manu">
                            <field name="manufacturing_date"/>
                            <field name="reception_date"/>
                        </group>
                    </group>
                    
                    <group>
                        <group name="quality">
                            <field name="quality_status" widget="badge"
                                   decoration-success="quality_status == 'approved'"
                                   decoration-danger="quality_status == 'rejected'"
                                   decoration-warning="quality_status == 'quarantine'"/>
                            <field name="certificate_of_analysis" filename="certificate_filename"/>
                            <field name="certificate_filename" invisible="1"/>
                        </group>
                        <group name="alerts">
                            <field name="alert_expiry_days"/>
                            <field name="is_expiring_soon" readonly="1"/>
                            <field name="is_expired" readonly="1"/>
                        </group>
                    </group>
                    
                    <group>
                        <field name="compliance_notes" placeholder="Notes pour audit et conformité réglementaire..."/>
                    </group>
                </page>
            </xpath>
        </field>
    </record>
    
    <!-- Vue Tree Lot avec alertes -->
    <record id="view_stock_lot_tree_alerts" model="ir.ui.view">
        <field name="name">stock.lot.tree.alerts</field>
        <field name="model">stock.lot</field>
        <field name="inherit_id" ref="stock.view_production_lot_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//list" position="attributes">
                <attribute name="decoration-danger">is_expired</attribute>
                <attribute name="decoration-warning">is_expiring_soon</attribute>
            </xpath>
            <xpath expr="//field[@name='ref']" position="after">
                <field name="expiration_date"/>
                <field name="quality_status" optional="hide"/>
                <field name="is_expiring_soon" invisible="1"/>
                <field name="is_expired" invisible="1"/>
            </xpath>
        </field>
    </record>
    
    <!-- Filtre Lots Expirants -->
    <record id="view_stock_lot_search_expiry" model="ir.ui.view">
        <field name="name">stock.lot.search.expiry</field>
        <field name="model">stock.lot</field>
        <field name="inherit_id" ref="stock.search_product_lot_filter"/>
        <field name="arch" type="xml">
            <xpath expr="//search" position="inside">
                <separator/>
                <filter string="Expire Bientôt" name="expiring_soon" 
                        domain="[('is_expiring_soon', '=', True)]"/>
                <filter string="Expiré" name="expired" 
                        domain="[('is_expired', '=', True)]"/>
                <separator/>
                <filter string="En Quarantaine" name="quarantine" 
                        domain="[('quality_status', '=', 'quarantine')]"/>
                <filter string="Approuvé" name="approved" 
                        domain="[('quality_status', '=', 'approved')]"/>
            </xpath>
        </field>
    </record>
    
    <!-- Menu Lots Expirants -->
    <record id="action_stock_lot_expiring" model="ir.actions.act_window">
        <field name="name">Lots Expirant Bientôt</field>
        <field name="res_model">stock.lot</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[('is_expiring_soon', '=', True)]</field>
        <field name="context">{'search_default_expiring_soon': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Aucun lot expirant bientôt
            </p>
            <p>
                Les lots avec une date d'expiration proche apparaissent ici.
                Configurez les alertes dans les paramètres de chaque lot.
            </p>
        </field>
    </record>
    
    <menuitem id="menu_stock_lot_expiring"
              name="Lots Expirant"
              parent="stockex.menu_stockex_reports"
              action="action_stock_lot_expiring"
              sequence="50"/>

</odoo>
